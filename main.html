<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>団体ブログ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-open { overflow: hidden; }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .fade-out { animation: fadeOut 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        .form-input { @apply w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500; }
        .form-label { @apply block text-gray-700 text-sm font-bold mb-2; }
        .admin-only, .logged-out-only { display: none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- ヘッダー -->
    <header class="bg-white shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">私たちの活動ブログ</h1>
                <p class="text-gray-600 mt-1">最新の活動報告やお知らせを更新しています。</p>
            </div>
            <div id="admin-menu" class="flex items-center gap-4">
                <button id="new-post-btn" class="admin-only bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">新規投稿</button>
                <button id="logout-btn" class="admin-only bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">ログアウト</button>
            </div>
        </div>
    </header>

    <!-- メインコンテンツ -->
    <main class="container mx-auto px-6 py-12">
        <div id="posts-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Firestoreから読み込んだブログ記事がここに挿入されます -->
        </div>
    </main>

    <!-- フッター -->
    <footer class="bg-white mt-12 py-6">
        <div class="container mx-auto px-6 text-center text-gray-500">
            <p>&copy; 2025 [あなたの団体名]. All Rights Reserved.</p>
            <div class="mt-4">
                 <button id="login-btn" class="logged-out-only text-gray-500 hover:text-gray-700 hover:underline text-sm transition-colors">管理者ログイン</button>
            </div>
        </div>
    </footer>

    <!-- 記事詳細・編集用モーダル -->
    <div id="post-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50">
        <div id="modal-content" class="bg-white rounded-lg shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto relative fade-in">
            <div id="modal-body" class="p-8"></div>
        </div>
    </div>

    <!-- ログインモーダル -->
    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-sm p-8 fade-in relative">
            <h2 class="text-2xl font-bold text-center text-gray-900 mb-6">管理者ログイン</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label class="form-label" for="login-email">メールアドレス</label>
                    <input class="form-input" id="login-email" type="email" placeholder="admin@example.com" required>
                </div>
                <div class="mb-4">
                    <label class="form-label" for="login-password">パスワード</label>
                    <input class="form-input" id="login-password" type="password" placeholder="********" required>
                </div>
                <p id="login-error" class="text-red-500 text-sm mb-4 h-5"></p>
                <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">ログイン</button>
            </form>
            <button id="close-login-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Firebaseライブラリをインポート
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, setDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- あなたのFirebaseプロジェクト設定 ---
        const firebaseConfig = {
            apiKey: "AIzaSyAiJ2woI6yEFDBYpdD-SQkPuBuJ8wPjI0o",
            authDomain: "glocallabo-5a648.firebaseapp.com",
            projectId: "glocallabo-5a648",
            storageBucket: "glocallabo-5a648.appspot.com",
            messagingSenderId: "284774520564",
            appId: "1:284774520564:web:72d7f6d8fe6b24196bb0a1",
            measurementId: "G-6EZCFTW65Q"
        };

        // Firebaseを初期化
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const postsCollection = collection(db, "blogPosts");
        
        // --- JavaScriptの処理 ---
        document.addEventListener('DOMContentLoaded', () => {
            let isLoggedIn = false;
            let localPostsCache = [];

            const postsContainer = document.getElementById('posts-container');
            const modal = document.getElementById('post-modal');
            const modalContent = document.getElementById('modal-content');
            const modalBody = document.getElementById('modal-body');
            
            const loginBtn = document.getElementById('login-btn');
            const newPostBtn = document.getElementById('new-post-btn');
            const logoutBtn = document.getElementById('logout-btn');

            const loginModal = document.getElementById('login-modal');
            const loginForm = document.getElementById('login-form');
            const emailInput = document.getElementById('login-email');
            const passwordInput = document.getElementById('login-password');
            const loginError = document.getElementById('login-error');
            const closeLoginModalBtn = document.getElementById('close-login-modal-btn');

            // --- UI更新関連 ---
            function updateAdminUI() {
                const adminElements = document.querySelectorAll('.admin-only');
                const loggedOutElements = document.querySelectorAll('.logged-out-only');
                if (isLoggedIn) {
                    adminElements.forEach(el => el.style.display = 'inline-block');
                    loggedOutElements.forEach(el => el.style.display = 'none');
                } else {
                    adminElements.forEach(el => el.style.display = 'none');
                    loggedOutElements.forEach(el => el.style.display = 'inline-block');
                }
                displayPosts(localPostsCache);
            }

            function showLoginModal() {
                loginError.textContent = '';
                emailInput.value = '';
                passwordInput.value = '';
                loginModal.classList.remove('hidden');
                loginModal.classList.add('flex');
            }

            function hideLoginModal() {
                loginModal.classList.add('hidden');
                loginModal.classList.remove('flex');
            }

            // --- ログイン・ログアウト処理 ---
            async function handleLogin(event) {
                event.preventDefault();
                const email = emailInput.value;
                const password = passwordInput.value;
                loginError.textContent = '';

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    // ログイン成功時の処理は onAuthStateChanged が行う
                    hideLoginModal();
                } catch (error) {
                    console.error("Login failed:", error);
                    loginError.textContent = 'メールアドレスまたはパスワードが違います。';
                }
            }

            async function handleLogout() {
                try {
                    await signOut(auth);
                    // ログアウト成功時の処理は onAuthStateChanged が行う
                } catch (error) {
                    console.error("Logout failed:", error);
                }
            }

            // --- 記事一覧表示 ---
            function displayPosts(posts) {
                postsContainer.innerHTML = '';
                posts.forEach(post => {
                    const postElement = document.createElement('div');
                    postElement.className = 'bg-white rounded-lg shadow-lg overflow-hidden flex flex-col';
                    
                    const adminButtons = isLoggedIn ? `
                        <div class="bg-gray-50 p-4 flex justify-end gap-2">
                            <button onclick="openModal('${post.id}', 'edit')" class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-1 px-3 rounded-lg transition-colors">編集</button>
                            <button onclick="deletePost('${post.id}')" class="text-sm bg-red-100 hover:bg-red-200 text-red-800 font-semibold py-1 px-3 rounded-lg transition-colors">削除</button>
                        </div>
                    ` : '';

                    postElement.innerHTML = `
                        <div class="p-6 flex-grow cursor-pointer" onclick="openModal('${post.id}')">
                            <p class="text-sm text-gray-500 mb-2">${post.date} | ${post.author}</p>
                            <h2 class="text-2xl font-bold text-gray-900 mb-3">${post.title}</h2>
                            <p class="text-gray-700">${post.snippet}</p>
                        </div>
                        ${adminButtons}
                    `;
                    postsContainer.appendChild(postElement);
                });
            }

            // --- モーダル関連 (変更なし) ---
            window.openModal = async (postId, mode = 'read') => {
                if (mode !== 'read' && !isLoggedIn) return;
                
                const post = localPostsCache.find(p => p.id === postId);
                if (!post && mode !== 'new') return;

                if (mode === 'read') {
                    renderReadView(post);
                } else {
                    renderEditView(post);
                }

                modal.classList.remove('hidden');
                modal.classList.add('flex');
                document.body.classList.add('modal-open');
                modalContent.classList.remove('fade-out');
                modalContent.classList.add('fade-in');
            }
            
            function renderReadView(post) {
                 const adminButtons = isLoggedIn ? `
                    <div class="flex justify-end gap-2">
                        <button onclick="openModal('${post.id}', 'edit')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">編集</button>
                        <button onclick="deletePost('${post.id}')" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">削除</button>
                    </div>
                ` : '';
                modalBody.innerHTML = `
                    <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                    <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">${post.title}</h2>
                    <p class="text-base text-gray-500 mb-6">${post.date} | ${post.author}</p>
                    <div class="prose max-w-none text-gray-800 text-lg leading-relaxed mb-8">${post.content.replace(/\n/g, '<br>')}</div>
                    ${adminButtons}
                `;
            }

            function renderEditView(post = null) {
                if (!isLoggedIn) return;
                const isNew = post === null;
                const postId = isNew ? '' : post.id;
                modalBody.innerHTML = `
                    <h2 class="text-3xl font-bold text-gray-900 mb-6">${isNew ? '新規投稿の作成' : '投稿の編集'}</h2>
                    <form id="post-form" data-post-id="${postId}">
                        <div class="mb-4"><label class="form-label" for="title">タイトル</label><input class="form-input" id="title" type="text" value="${isNew ? '' : post.title}" required></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div><label class="form-label" for="author">投稿者</label><input class="form-input" id="author" type="text" value="${isNew ? '管理者' : post.author}" required></div>
                            <div><label class="form-label" for="date">日付</label><input class="form-input" id="date" type="text" value="${isNew ? new Date().toLocaleDateString('ja-JP') : post.date}" required></div>
                        </div>
                        <div class="mb-4"><label class="form-label" for="snippet">概要</label><textarea class="form-input" id="snippet" rows="3" required>${isNew ? '' : post.snippet}</textarea></div>
                        <div class="mb-6"><label class="form-label" for="content">本文</label><textarea class="form-input" id="content" rows="10" required>${isNew ? '' : post.content}</textarea></div>
                        <div class="flex justify-end gap-4">
                            <button type="button" onclick="closeModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">キャンセル</button>
                            <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">保存</button>
                        </div>
                    </form>
                `;
                document.getElementById('post-form').addEventListener('submit', savePost);
            }

            window.closeModal = () => {
                modalContent.classList.remove('fade-in');
                modalContent.classList.add('fade-out');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    document.body.classList.remove('modal-open');
                    modalBody.innerHTML = '';
                }, 300);
            }

            // --- Firestoreデータ操作 (変更なし) ---
            async function savePost(event) {
                event.preventDefault();
                if (!isLoggedIn) return;
                const form = event.target;
                const postId = form.dataset.postId;
                const postData = { title: form.querySelector('#title').value, author: form.querySelector('#author').value, date: form.querySelector('#date').value, snippet: form.querySelector('#snippet').value, content: form.querySelector('#content').value, createdAt: postId ? (localPostsCache.find(p => p.id === postId).createdAt || new Date()) : new Date() };
                if (postId) { await setDoc(doc(db, "blogPosts", postId), postData, { merge: true }); } else { await addDoc(postsCollection, postData); }
                closeModal();
            }

            window.deletePost = async (postId) => {
                if (!isLoggedIn) return;
                if (confirm('本当にこの記事を削除しますか？')) {
                    await deleteDoc(doc(db, "blogPosts", postId));
                    if (!modal.classList.contains('hidden')) { closeModal(); }
                }
            }

            // --- 初期化処理 ---
            function initialize() {
                // イベントリスナー設定
                loginForm.addEventListener('submit', handleLogin);
                loginBtn.addEventListener('click', showLoginModal);
                logoutBtn.addEventListener('click', handleLogout);
                closeLoginModalBtn.addEventListener('click', hideLoginModal);
                newPostBtn.addEventListener('click', () => openModal(null, 'new'));
                modal.addEventListener('click', (event) => { if (event.target === modal) closeModal(); });
                document.addEventListener('keydown', (event) => { if (event.key === 'Escape' && !modal.classList.contains('hidden')) closeModal(); });

                // ★ ログイン状態を監視するリスナー ★
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // ユーザーがログインしている場合
                        isLoggedIn = true;
                    } else {
                        // ユーザーがログアウトしている場合
                        isLoggedIn = false;
                    }
                    updateAdminUI(); // UIを更新
                });

                // Firestoreのリアルタイムリスナーを設定
                const q = query(postsCollection, orderBy("createdAt", "desc"));
                onSnapshot(q, (snapshot) => {
                    const posts = [];
                    snapshot.forEach((doc) => {
                        posts.push({ ...doc.data(), id: doc.id });
                    });
                    localPostsCache = posts;
                    displayPosts(localPostsCache);
                });
            }

            initialize();
        });
    </script>
</body>
</html>

